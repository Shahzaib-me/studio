rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset enforces a strict user-ownership model.
     * All user-generated data, including devices, geofences, and alerts,
     * is segregated into private subcollections accessible only by the owning user.
     * This prevents any user from accessing another user's private information.
     *
     * Data Structure: All data is nested hierarchically under the /users/{userId}
     * path. This structure allows for simple, performant, and secure rules
     * that grant access to entire data trees based on a single path segment check.
     *
     * Key Security Decisions:
     * - User data is strictly private. Users can only access documents within
     *   their own `/users/{userId}` path.
     * - Listing all users is explicitly disallowed to protect user privacy.
     * - An administrative role is defined via the `/roles_admin` collection, but
     *   admins are not granted default access to user-private data to maintain
     *   the principle of least privilege. Admin access must be granted explicitly
     *   where needed.
     *
     * Denormalization for Authorization: Rules enforce that when a user-owned
     * document is created (e.g., a Device), it must contain a `userId` field
     * that matches the user's ID from the path. This denormalized field must be
     * immutable, ensuring ownership cannot be transferred or reassigned after
     * creation. This avoids costly `get` calls and provides a clear audit trail.
     *
     * Structural Segregation: The entire data model uses structural segregation.
     * By placing all user-specific data in a private `/users/{userId}` tree,
     * we ensure that `list` operations are inherently secure and efficient, as
     * they only ever operate on documents a user is already authorized to see.
     */

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    /**
     * Returns true if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is the owner and the document already exists.
     * Used for secure update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Returns true if the requesting user is a designated administrator.
     * Admin status is determined by the existence of a document in the
     * /roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Validates that the user is creating their own user profile document and
     * that the document's internal `id` field correctly matches their UID.
     */
    function isCreatingSelf(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Validates that the user is updating their own profile document and that
     * the document's internal `id` field remains unchanged.
     */
    function isUpdatingSelf(userId) {
      return isExistingOwner(userId) && request.resource.data.id == resource.data.id;
    }

    /**
     * Validates the creation of a new user-owned document (e.g., Device, Geofence).
     * Ensures the creator is the owner and the internal `userId` field matches their UID.
     */
    function isCreatingOwnedDoc(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }

    /**
     * Validates the update of a user-owned document.
     * Ensures the user is the owner and the `userId` field is immutable.
     */
    function isUpdatingOwnedDoc(userId) {
      return isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
    }


    //-------------------------------------------------------------------------
    // User Data Rules
    //-------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (create) A new user can create their own profile document if their UID matches the document ID.
     * @deny (list) A user cannot list all other user profiles in the system.
     * @principle Restricts access to a user's own data tree and enforces self-creation.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isCreatingSelf(userId);
      allow update: if isUpdatingSelf(userId);
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages tracking devices owned by a specific user.
       * @path /users/{userId}/devices/{deviceId}
       * @allow (create) The user can add a new device to their own profile.
       * @deny (get) A user cannot read device data belonging to another user.
       * @principle Enforces document ownership and validates relational integrity via the `userId` field.
       */
      match /devices/{deviceId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isCreatingOwnedDoc(userId);
        allow update: if isUpdatingOwnedDoc(userId);
        allow delete: if isExistingOwner(userId);

        /**
         * @description Manages location history for a specific device.
         * @path /users/{userId}/devices/{deviceId}/locations/{locationId}
         * @allow (list) The user can list location history for their own device.
         * @deny (create) An unauthorized user cannot add fake location data to someone else's device.
         * @principle Inherits ownership from the parent user document. Access is granted based on path.
         */
        match /locations/{locationId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update: if isExistingOwner(userId);
          allow delete: if isExistingOwner(userId);
        }
      }

      /**
       * @description Manages geofences (safe zones) created by a user.
       * @path /users/{userId}/geofences/{geofenceId}
       * @allow (create) The user can create a geofence under their own profile.
       * @deny (update) A user cannot modify a geofence belonging to another user.
       * @principle Enforces document ownership and validates relational integrity via the `userId` field.
       */
      match /geofences/{geofenceId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isCreatingOwnedDoc(userId);
        allow update: if isUpdatingOwnedDoc(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages alerts generated for a user's devices.
       * @path /users/{userId}/alerts/{alertId}
       * @allow (get) The user can read alerts generated for their devices.
       * @deny (delete) A user cannot delete alerts from another user's account.
       * @principle Enforces document ownership and validates relational integrity via the `userId` field.
       */
      match /alerts/{alertId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isCreatingOwnedDoc(userId);
        allow update: if isUpdatingOwnedDoc(userId);
        allow delete: if isExistingOwner(userId);
      }
    }

    //-------------------------------------------------------------------------
    // Admin Role Rules
    //-------------------------------------------------------------------------

    /**
     * @description Manages administrator roles. The existence of a document
     *   in this collection grants a user admin privileges.
     * @path /roles_admin/{userId}
     * @allow (create) An existing admin can grant admin privileges to another user.
     * @deny (list) A non-admin cannot list all system administrators.
     * @principle Restricts a highly sensitive collection to be managed only by existing admins.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }
  }
}